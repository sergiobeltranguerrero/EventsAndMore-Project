{% extends "home_base.html" %}
{% load carton_tags %}

{% block title %}Carro de servicios{% endblock %}


{% block body %}

    <section class="h-100" style="background-color: #ffffff;">

        <div class="container h-100 py-5">
            <div class="row d-flex justify-content-center align-items-center h-100">
                <div class="col-10">


                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-normal mb-0 text-black">Carro de Servicios</h2>
                    </div>

                    {% for item in cart %}
                        <div class="card rounded-3 mb-4" style="background-color: #fff;">
                            <div class="card-body p-4">
                                <div class="row d-flex justify-content-between align-items-center">
                                    <div class="col-md-2 col-lg-2 col-xl-2">
                                        <img src="{{ MEDIA_URL }}{{ item.servicio.imagen }}"
                                             alt="{{ item.servicio.nombre }}" class="img-fluid rounded-3">
                                    </div>
                                    <div class="col-md-3 col-lg-3 col-xl-3">
                                        <input type="hidden" name="id_producto" value="{{ item.id }}"/>
                                        <input type="hidden" name="id_servicio" value="{{ item.servicio.id }}"/>
                                        <p class="lead fw-normal mb-2">{{ item.servicio.nombre }}</p>
                                        <p><span class="text-muted">Precio: </span><span
                                                class="precio_{{ item.id }}">{{ item.servicio.precio }} €</span></p>

                                    </div>
                                    <div class="col-md-3 col-lg-3 col-xl-2 d-flex">

                                        <input id="form1" min="1" name="cantidad"
                                               value={{ item.cantidad }} type="number"
                                               class="form-control form-control-sm cantidad"/>
                                    </div>
                                    <div class="col-md-3 col-lg-2 col-xl-2 offset-lg-1">
                                        <h5 class="mb-0" id="subtotal_{{ item.id }}">{{ item.subtotal }} €</h5>
                                        <a class="btn btn-outline-danger btn-sm mt-2 delete_element">Eliminar</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <div class="card rounded-3 mb-4" style="background-color: #fff;">
                        <div class="card-body p-4">
                            <div class="col-md-6 col-lg-4 col-xl-6 offset-lg-4 text-end">
                                <h5 class="mb-0" id="id_total">{{ cart.total }} €</h5>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <button type="button" class="btn btn-warning btn-block btn-lg">Reservar</button>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <a class="btn btn-primary btn-lg" href="{% url 'servicios' evento=cart.evento stand=cart.stand %}">Volver a los servicios</a>
                    </div>
                </div>
            </div
        </div>
    </section>

{% endblock %}

{% block javascript %}
    <script>
        $(document).ready(function () {
            $('input.cantidad').change(function () {
                const cantidad = Number($(this).val());
                const id_producto = Number($(this).parent().parent().find('input[name="id_producto"]').val());
                const str_precio = $('.precio_' + id_producto).text();
                const precio = parseFloat(str_precio.replace(',', '.').replace(' ', ''))
                const subtotal = Number(precio * Number(cantidad)).toFixed(2).replace('.', ',');
                const id_servicio = Number($(this).parent().parent().find('input[name="id_servicio"]').val());
                $('#subtotal_' + id_producto).text(subtotal + ' €');
                $.ajax({
                    url: '/cart/update/',
                    type: 'POST',
                    data: {
                        'id_evento': {{ cart.evento }},
                        'id_stand': {{ cart.stand }},
                        'id_servicio': id_servicio,
                        'quantity': cantidad,
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    success: function (data) {
                        const total = data.total;
                        $('#id_total').text(total.replace('.', ',') + ' €');
                    }
                })
            });
            $('a.delete_element').on('click', function (e) {
                e.preventDefault();
                const id_servicio = Number($(this).parent().parent().find('input[name="id_servicio"]').val());
                $.ajax({
                    url: '/cart/delete/',
                    type: 'POST',
                    data: {
                        'id_evento': {{ cart.evento }},
                        'id_stand': {{ cart.stand }},
                        'id_servicio': id_servicio,
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    success: function (data) {
                        //Reload page
                        location.reload();
                    }
                })
            });
        });
    </script>
{% endblock javascript %}